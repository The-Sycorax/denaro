version: '3.8'

# All nodes share these settings and environment variables
# Individual nodes can override them as needed
x-denaro-node-base: &denaro-node-base
  build: .
  restart: unless-stopped
  working_dir: /app
  env_file: [.env]
  labels: ["denaro.node=true"]
  networks: [denaro-net]
  volumes:
    - type: volume
      target: /app
    - type: volume
      source: node-registry
      target: /registry
  environment:
    &denaro-node-env
    DENARO_DATABASE_HOST: 'postgres'
    DENARO_NODE_HOST: '0.0.0.0'

services:
  postgres:
    image: postgres:14
    env_file: [.env]
    volumes: [postgres_data:/var/lib/postgresql/data]
    networks: [denaro-net]

  node-3006:
    <<: *denaro-node-base
    hostname: node-3006
    volumes: [node_3006_data:/app, node-registry:/registry]
    depends_on: [postgres]
    environment:
      <<: *denaro-node-env
      NODE_NAME: 'node-3006'
      DENARO_NODE_PORT: '3006'
      DENARO_BOOTSTRAP_NODE: 'self'

volumes:
  node-registry:
  node_3006_data:
  postgres_data:

networks:
  denaro-net:
    driver: bridge